# План реализации Telegram Mini App "Shuffle Messages"

Этот документ содержит детальный план реализации функции случайного послания для Telegram-канала.

---

## Задача 1: Инициализация проекта и базовой структуры
**Контекст выполнения:**
- **Файлы:** Создание структуры проекта Next.js в корне `/Users/maxzhadobin/Tel_post_shuffle`.
- **Изменения:** 
    - Инициализация `package.json` с зависимостями: `next`, `react`, `react-dom`, `@upstash/redis`, `@telegram-apps/sdk`.
    - Создание базовых путей: `src/app`, `src/components`, `src/lib`.
- **Цель:** Подготовить рабочую среду для разработки TMA.

**Миграционные инструкции:**
- Не применимо (новый проект).

**Документационные требования:**
- Обновить `README.md` (создать): добавить инструкции по локальному запуску `npm install && npm run dev`.
- Техническая документация: описать выбор стека (Next.js + Tailwind + Redis).

**Тестовые требования:**
- Добавить базовый тест `vitest` для проверки рендеринга главной страницы.
- Файл: `src/__tests__/page.test.tsx`.

---

## Задача 2: Интеграция с Redis (Upstash) и загрузка данных
**Контекст выполнения:**
- **Файлы:** 
    - `src/lib/redis.ts`: Клиент для подключения к Upstash Redis.
    - `scripts/upload_links.ts`: Скрипт для первичной загрузки данных из JSON-файла в Redis.
- **Изменения:**
    - В `src/lib/redis.ts` реализовать экспорт экземпляра `Redis`.
    - В `scripts/upload_links.ts` реализовать чтение массива объектов `{ "url": string, "text": string }` и сохранение их в Redis Set `posts_pool` в виде JSON-строк.
- **Переменные окружения:** `UPSTASH_REDIS_REST_URL`, `UPSTASH_REDIS_REST_TOKEN`.

**Миграционные инструкции:**
- Подготовить файл `data/posts.json` с массивом объектов (ссылка + аффирмация/цитата).
- Выполнить `npx tsx scripts/upload_links.ts` для наполнения базы данных.

**Документационные требования:**
- Техническая документация: описать структуру данных в Redis (Set: `posts_pool`, элементы: сериализованный JSON).

**Тестовые требования:**
- Создать интеграционный тест для проверки десериализации данных из Redis.

---

## Задача 3: Создание API Route для получения случайного послания
**Контекст выполнения:**
- **Файлы:** `src/app/api/shuffle/route.ts`.
- **Изменения:**
    - Реализовать `GET` обработчик.
    - Логика: вызов `await redis.srandmember('posts_pool')`.
    - Парсинг JSON-строки из Redis.
    - Возвращать JSON: `{ "url": "https://t.me/c/...", "text": "Твое послание на сегодня..." }`.
- **Безопасность:** Добавить проверку `initData` от Telegram.

**Миграционные инструкции:**
- Не применимо.

**Документационные требования:**
- Техническая документация: описать эндпоинт `/api/shuffle`, формат ответа (url + text).

**Тестовые требования:**
- Тест API: проверить корректную обработку случая, когда база пуста.

---

## Задача 4: Разработка интерфейса Mini App (Эстетика и Интерактив)
**Контекст выполнения:**
- **Целевая аудитория:** Девушки 20-40 лет. Тематика: самопознание, магическое мышление, любовь к себе.
- **Файлы:** 
    - `src/app/page.tsx`: Главная страница.
    - `src/components/MessageCard.tsx`: Компонент анимированной карточки.
    - `src/components/MagicButton.tsx`: Кнопка с эффектом свечения.
- **Изменения:**
    - **Дизайн:** Использовать эстетику "Soft Magic" — мягкие градиенты (лаванда, нежный розовый, золото), размытые фоны (glassmorphism), тонкие шрифты.
    - **UX Flow (Вариант Б):**
        1. Начальное состояние: Кнопка "Получить послание".
        2. После клика: Плавное появление (анимация `framer-motion`) карточки с текстом послания.
        3. На карточке: Текст цитаты и кнопка "Перейти к посту", которая открывает ссылку.
    - Интеграция `@telegram-apps/sdk` для адаптации под тему мессенджера.

**Миграционные инструкции:**
- Установить `framer-motion` для анимаций: `npm install framer-motion`.

**Документационные требования:**
- Техническая документация: описать используемую цветовую палитру и компоненты анимации.

**Тестовые требования:**
- Проверить адаптивность интерфейса на разных размерах экранов (мобильные устройства).
- Тестирование анимации появления карточки.

---

## Задача 5: Деплой на Vercel и конфигурация BotFather
**Контекст выполнения:**
- **Инструменты:** Vercel CLI, Telegram @BotFather.
- **Изменения:**
    - Деплой проекта: `vercel deploy --prod`.
    - В BotFather: Команда `/newapp`, выбор бота, ввод URL (выданный Vercel).
    - Получение `Short Name` приложения для формирования ссылки.
- **Результат:** Ссылка вида `https://t.me/bot_username/app_name`.

**Миграционные инструкции:**
- Настройка Environment Variables в панели Vercel (Redis credentials).

**Документационные требования:**
- Итоговая документация: обновить инструкцию по добавлению ссылки в закреп канала.

**Тестовые требования:**
- Ручная проверка открытия приложения внутри Telegram на мобильном устройстве и десктопе.
