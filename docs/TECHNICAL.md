# Техническая документация: Shuffle Mindfulness TMA

## Архитектура системы

Приложение построено на базе **Next.js 14** с использованием App Router и развернуто на **Vercel Edge Runtime** для обеспечения минимальной задержки.

### Компоненты
1. **Frontend**: React-приложение с использованием Tailwind CSS и Framer Motion. Интегрировано с Telegram WebApp SDK.
2. **API (Backend)**: Edge API Routes в Next.js. Выполняет роль прослойки между клиентом и Redis.
3. **Database**: Upstash Redis (Serverless). Используется для хранения пула постов.

## Схема данных (Redis)

Данные хранятся в Redis Set с ключом `posts_pool`.
Каждый элемент множества представляет собой JSON-строку следующей структуры:

```json
{
  "url": "string",  // Ссылка на пост в Telegram (https://t.me/c/...)
  "text": "string"  // Текст послания/цитаты
}
```

## API Спецификация

### GET `/api/shuffle`

Получает случайное послание из пула.

**Заголовки:**
- `x-telegram-init-data`: (обязательно в prod) Данные `window.Telegram.WebApp.initData` для валидации.

**Ответы:**
- `200 OK`: 
  ```json
  {
    "url": "https://t.me/c/123/45",
    "text": "Твое послание..."
  }
  ```
- `401 Unauthorized`: Невалидная подпись Telegram.
- `404 Not Found`: База данных пуста.
- `500 Internal Server Error`: Ошибка на стороне сервера.

## Безопасность

### Валидация Telegram
Все запросы к API валидируются на стороне сервера с использованием `HMAC-SHA256` и `TELEGRAM_BOT_TOKEN`. Это гарантирует, что данные были действительно отправлены из легитимного клиента Telegram.

## Интеграция с Telegram TMA

Приложение использует следующие возможности SDK:
- `expand()`: Раскрытие приложения на весь экран.
- `ready()`: Уведомление клиента о готовности.
- `HapticFeedback`: Тактильный отклик при получении нового послания.
- `initData`: Используется для идентификации и безопасности.

## Тестирование
- **Unit-тесты**: Vitest + React Testing Library.
- **Расположение**: `src/__tests__/`.
- **Запуск**: `npm test`.
